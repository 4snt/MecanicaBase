name: Build & Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup JDK 17 + cache Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Build (mvn -Puml)
        run: mvn -B -Puml clean package

      - name: Extrair notas do CHANGELOG
        id: changelog
        run: |
          TAG_NAME="${GITHUB_REF#refs/tags/}"
          VERSION="${TAG_NAME#v}"
          NOTES=$(awk "/^### ${VERSION//./\\.}/ {flag=1; next} /^### / {flag=0} flag" CHANGELOG.md)
          [ -z \"$NOTES\" ] && NOTES="Notas n√£o encontradas no CHANGELOG para $VERSION."
          echo "release_notes<<EOF" >> $GITHUB_ENV
          echo "$NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Criar/atualizar Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ env.release_notes }}
          fail_on_unmatched_files: true
          files: |
            target/MecanicaBase-dist.zip
